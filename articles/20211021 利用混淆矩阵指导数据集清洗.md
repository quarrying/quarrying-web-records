#! https://zhuanlan.zhihu.com/p/424212730
# 利用混淆矩阵指导分类数据集清洗

最近完成了一个植物识别的训练 (训练集是自建的, 共 4,066 类, 1,306,738 张图像), 在测试集 (145,168 张图像) 上性能表现不佳 (Top1 Acc 为 0.848, Top5 Acc 为 0.959), 遂想到用训练得到的模型在该训练集上计算混淆矩阵, 并用其来指导数据清洗. 经过尝试, 最终方法如下:
1) 比较 recall_i (混淆矩阵第 i 行第 i 列的元素) 和 top1_i (混淆矩阵第 i 行的最大值). 如果两者不相等, 即认为第 i 类可能存在较多噪声, 不妨称为 dirty class.
2) 当 recall_i 等于 top1_i 时, 比较 recall_i 和 top2_i (混淆矩阵第 i 行的第二大值). 如果 recall_i 和 top2_i 之差小于一定的阈值 thresh, 即认为第 i 类可能存在较多噪声 (即为 dirty class). 为了设置一个与实际样本数无关的阈值, 先对混淆矩阵按所在行的实际样本数进行归一化.
3) 对于每个 dirty class, 计算其混淆矩阵对应行上的 top_k 个值, 在 top_k 类中排除 dirty class, 剩余的类称为该 dirty class 的干扰类 (distract classes). 
4) 人工检查上面得到的 dirty class 及其 distract classes 的数据, 或清洗, 或合并.

该方法在植物识别训练集上得到 17 个 dirty class (thresh 为 0.1, top_k 为 1), 如下所示, 其中每一组的第一行是 dirty class 的召回率和标签, 第二行是该 dirty class 的 distract classes 对应列的漏检率和标签):
```
[1] 0.5015, 兰科_手参属 Gymnadenia nigra
    0.4715, 兰科_手参属 Gymnadenia rhellicani
[2] 0.4767, 兰科_杓兰属 Cypripedium calcicola #褐花杓兰
    0.4651, 兰科_杓兰属 Cypripedium tibeticum #西藏杓兰
[3] 0.4355, 唇形科_夏枯草属 Prunella hispida #硬毛夏枯草
    0.5242, 唇形科_夏枯草属 Prunella vulgaris #夏枯草
[4] 0.4689, 唇形科_大青属 Clerodendrum lindleyi #尖齿臭茉莉
    0.4379, 唇形科_大青属 Clerodendrum bungei #臭牡丹
[5] 0.4254, 天门冬科_玉簪属 Hosta albomarginata #紫玉簪
    0.4377, 天门冬科_玉簪属 Hosta ventricosa #紫萼
[6] 0.2006, 杜鹃花科_杜鹃花属 Rhododendron × pulchrum #锦绣杜鹃
    0.6783, 杜鹃花科_杜鹃花属 Rhododendron simsii #杜鹃
[7] 0.2059, 玄参科_醉鱼草属 Buddleja fallowiana #紫花醉鱼草
    0.5980, 玄参科_醉鱼草属 Buddleja davidii #大叶醉鱼草
[8] 0.3960, 百合科_大百合属 Cardiocrinum giganteum var. yunnanense #云南大百合
    0.4430, 百合科_大百合属 Cardiocrinum giganteum #大百合
[9] 0.4472, 睡莲科_睡莲属 Nymphaea alba #白睡莲
    0.4797, 睡莲科_睡莲属 Nymphaea
[10] 0.3261, 睡莲科_睡莲属 Nymphaea nouchali #延药睡莲
     0.6594, 睡莲科_睡莲属 Nymphaea
[11] 0.3036, 美人蕉科_美人蕉属 Canna generalis #大花美人蕉
     0.6145, 美人蕉科_美人蕉属 Canna
[12] 0.3588, 美人蕉科_美人蕉属 Canna indica var. flava #黄花美人蕉
     0.4941, 美人蕉科_美人蕉属 Canna
[13] 0.4628, 美人蕉科_美人蕉属 Canna orchioides #兰花美人蕉
     0.4662, 美人蕉科_美人蕉属 Canna
[14] 0.3429, 茄科_木曼陀罗属 Brugmansia suaveolens #大花木曼陀罗
     0.4190, 茄科_曼陀罗属 Datura stramonium #曼陀罗
[15] 0.4802, 菊科_茼蒿属 Glebionis segetum #南茼蒿
     0.4484, 菊科_茼蒿属 Glebionis coronaria #茼蒿
[16] 0.4959, 蓼科_金线草属 Antenoron filiforme var. neofiliforme #短毛金线草
     0.4008, 蓼科_金线草属 Antenoron filiforme #金线草
[17] 0.4352, 蔷薇科_绣线菊属 Spiraea × bumalda 'Goalden Mound' #金山绣线菊
     0.3472, 蔷薇科_绣线菊属 Spiraea japonica #粉花绣线菊
```
由上面结果可见 dirty class 和 distract classes 很多都是同属的 (这很符合直觉, 有的同属植物外观相似性大, 本身而言和对人而言都是不易区别的). 

## **更新记录**
- 20211021, 发布

## **版权声明**
自由转载-非商用-非衍生-保持署名 ([创意共享3.0许可证](https://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh))
